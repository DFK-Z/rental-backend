generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String
  password  String
  role      String   @default("client")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ТОЛЬКО нужные связи
  rentals Rental[]

  @@map("users")
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  parentId  Int?     @map("parent_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Связи
  parent    Category?   @relation("CategoryToCategory", fields: [parentId], references: [id])
  children  Category[]  @relation("CategoryToCategory")
  equipment Equipment[]

  @@map("categories")
}

model Equipment {
  id           Int      @id @default(autoincrement())
  title        String
  description  String
  priceCents   Int      @map("price_cents")
  depositCents Int?     @map("deposit_cents")
  categoryId   Int      @map("category_id")
  status       String   @default("available")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Связи
  category     Category                @relation(fields: [categoryId], references: [id])
  rentals      Rental[]
  availability EquipmentAvailability[]

  @@map("equipment")
}

model Rental {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  equipmentId Int      @map("equipment_id")
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  totalCents  Int      @map("total_cents")
  status      String   @default("pending")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Связи
  user         User                    @relation(fields: [userId], references: [id])
  equipment    Equipment               @relation(fields: [equipmentId], references: [id])
  payments     Payment[]
  availability EquipmentAvailability[]
  promoCodeId  Int?                    @map("promo_code_id") // ДОБАВИТЬ
  promoCode    PromoCode?              @relation(fields: [promoCodeId], references: [id]) // ДОБАВИТЬ

  @@map("rentals")
}

model Payment {
  id          Int      @id @default(autoincrement())
  rentalId    Int      @map("rental_id")
  amountCents Int      @map("amount_cents")
  type        String // deposit, payment, refund, penalty
  status      String   @default("pending")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Связь
  rental Rental @relation(fields: [rentalId], references: [id], onDelete: Cascade)

  @@index([rentalId])
  @@index([status])
  @@index([type])
  @@map("payments")
}

model EquipmentAvailability {
  id          Int       @id @default(autoincrement()) // ИСПРАВЛЕНО: теперь Int
  equipmentId Int       @map("equipment_id")
  equipment   Equipment @relation(fields: [equipmentId], references: [id])
  date        DateTime // день доступности
  status      String // "available", "booked", "maintenance"
  rentalId    Int?      @map("rental_id") // ДОБАВЛЕНО: связь с бронированием
  rental      Rental?   @relation(fields: [rentalId], references: [id])
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@unique([equipmentId, date])
  @@map("equipment_availability")
}

model PromoCode {
  id            Int      @id @default(autoincrement())
  code          String   @unique
  discountType  String   @map("discount_type") // "percentage" или "fixed"
  discountValue Int      @map("discount_value") // например: 10 для 10% или 500 для 500 рублей
  validFrom     DateTime @map("valid_from")
  validUntil    DateTime @map("valid_until")
  maxUses       Int?     @map("max_uses") // null = без ограничений
  usedCount     Int      @default(0) @map("used_count")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Связи
  rentals Rental[]

  @@map("promo_codes")
}
